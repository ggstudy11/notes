## 红包系统开发
> 该部分我们将探讨项目中红包系统的开发，同时会考虑到高并发等问题

- 场景：考虑仿照微信红包系统，开发一个红包系统，需要设计到发红包和抢红包两个业务功能。

- 涉及技术点：
  - Redis缓存
  - 异步
  - 分布式锁

- 具体设计：
  - 发红包功能开发：  
    与微信略有不同的是，微信发出红包后金额的大小是随机的而不是事先分配好的，这里我们简化考虑，比如发一个M金额N份的红包，我们可以先把红包划分成N份随机大小存入缓存的List中，当有人点击时弹出一份，然后把这条记录异步写入数据库。
    - 具体流程：  
      1. 发红包时生成唯一标识传给前端，同时记录数据库
      2. 利用算法(这里我们并不关心)将红包金额随机划分，写入缓存，同时开启异步线程写入数据库
  - 抢红包功能开发：  
    抢红包时需要前端传入抢红包的用户id以及红包的唯一标识，抢红包时先进行各种校验，通过后还需要判断是否抢过红包(用户唯一性),再从缓存队列中弹出一份随机金额，返回给前端，但是同时还需要异步写入数据库中，记录用户抢红包数据。
    - 具体流程：  
      1. 各种合法性校验
      2. 判断用户是否抢过红包，即redis的get操作
      3. 如果没有弹出一份随机金额然后返回，同时开启线程异步写入数据库

如上红包系统的开发大致完成，可以思考一下存在什么问题？  
显然，我们这个系统存在很大的问题，接下来一一考虑：  
1. 并发性问题：  
  考虑有多个线程同时执行这个方法，进行用户是否抢过红包的判断时会产生线程安全问题，导致一个用户抢了同一个红包多次，这里考虑用锁的方式进行处理，但是考虑到分布式架构，不同jvm中锁监视器是不同的，这里我们需要用到分布式锁。  
  用redis解决分布式锁问题，这里即用redis的setnx的方式进行分布式锁处理，同时我们需要给锁设定一个时间，防止服务宕机导致死锁问题。其实这里用redis锁还存在问题，用redission的锁为最佳。
2. 红包过期后退回金额问题：  
  红包过期后如何进行金额返还？初步考虑这里把缓存中的红包不设置过期时间，而是通过逻辑时间来存放，同时开启定时任务检查红包是否过期？ 破案了用延时队列解决即可
